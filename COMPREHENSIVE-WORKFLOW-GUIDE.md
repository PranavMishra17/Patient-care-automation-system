# üè• Healthcare Pipeline - Complete Workflow Guide

## üéâ **What You've Built**

You now have a comprehensive HIPAA-compliant healthcare automation pipeline with:

### ‚úÖ **Core Features Implemented:**
- **Patient Intake** with PHI encryption
- **AI-Powered Triage** using Azure OpenAI
- **Specialist Assignment** from pool of 10 specialists
- **Slack Integration** with interactive buttons (Accept/Decline)
- **Email Integration** with professional reports
- **SMS Integration** for patient notifications
- **Redis Caching** for case management
- **PostgreSQL Database** with synthetic patient data
- **Automatic Reassignment** if specialist declines
- **Medical Report Generation** with patient history

## üóÉÔ∏è **Database Status**

Your database now contains:

### **Specialists Available:**
- **Dr. James Smith** - Cardiology (High availability)
- **Dr. Sarah Jones** - Cardiology (Medium availability)  
- **Dr. Michael Williams** - Endocrinology (High availability)
- **Dr. Lisa Brown** - Neurology (Low availability)
- **Dr. Robert Davis** - Internal Medicine (High availability)
- **Dr. Maria Garcia** - Psychiatry (Medium availability)
- **Dr. Carlos Martinez** - Rheumatology (High availability)
- **Dr. Jennifer Taylor** - Gastroenterology (Medium availability)
- **Dr. William Anderson** - Pulmonology (Low availability)
- **Dr. Emily Thomas** - Dermatology (High availability)

### **Synthetic Patient Data:**
- **5 patients** with complete medical histories
- **Allergies, medications, conditions** for realistic testing
- **Lab results and family history** for comprehensive reports

## üîß **Setup Instructions**

### **Step 1: Environment Variables Check**

First, ensure your Azure OpenAI environment variables are working. Go to http://localhost:5678 and check if the Azure OpenAI node shows proper values (not [undefined]).

If still showing [undefined]:
1. Restart n8n: `docker compose restart n8n`
2. Check your `.env` file has these values:
```bash
AZURE_OPENAI_API_KEY=your_actual_key
AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com/
AZURE_OPENAI_DEPLOYMENT_NAME=your_deployment_name
AZURE_OPENAI_API_VERSION=2024-02-15-preview
```

### **Step 2: Import the Complete Workflow**

1. **Go to n8n**: http://localhost:5678
2. **Import workflow**: Use `healthcare-complete-workflow.json`
3. **Set up credentials** for each service:

#### **Required Credentials:**

**PostgreSQL Credential:**
- **Host**: postgres
- **Database**: n8n_healthcare
- **User**: n8n
- **Password**: [your DB_PASSWORD from .env]

**Redis Credential:**
- **Host**: redis
- **Password**: [your REDIS_PASSWORD from .env]

**Slack Credential:**
- **OAuth Token**: [your SLACK_BOT_TOKEN from .env]

**SendGrid Credential:**
- **API Key**: [your SENDGRID_API_KEY from .env]

**Twilio Credential:**
- **Account SID**: [your TWILIO_ACCOUNT_SID from .env]
- **Auth Token**: [your TWILIO_AUTH_TOKEN from .env]

### **Step 3: Test the Complete Workflow**

#### **Test Patient Data (Use one of these emails for medical history lookup):**

```json
{
  "firstName": "John",
  "lastName": "Doe",
  "age": 55,
  "gender": "Male",
  "phoneNumber": "+15551234567",
  "email": "john.doe@email.com",
  "chiefComplaint": "Chest pain and shortness of breath",
  "symptoms": "Severe chest pain, difficulty breathing, fatigue for the past 2 hours",
  "medicalHistory": "Hypertension, diabetes type 2, previous cardiac catheterization"
}
```

```json
{
  "firstName": "Jane",
  "lastName": "Smith",
  "age": 42,
  "gender": "Female", 
  "phoneNumber": "+15559876543",
  "email": "jane.smith@email.com",
  "chiefComplaint": "Fatigue and weight gain",
  "symptoms": "Extreme fatigue, unexplained weight gain, cold intolerance",
  "medicalHistory": "Thyroidectomy in 2021, hypothyroidism"
}
```

#### **Expected Workflow:**

1. **Patient submits data** ‚Üí **PHI encrypted**
2. **Azure OpenAI analyzes** ‚Üí **Determines specialist needed**
3. **Database lookup** ‚Üí **Finds available specialists**
4. **Redis caches case** ‚Üí **Case stored for tracking**
5. **Slack alert sent** ‚Üí **Specialist gets notification with buttons**
6. **Specialist clicks Accept/Decline**:

   **If ACCEPT:**
   - Medical history retrieved from database
   - Comprehensive medical report generated by AI
   - Specialist receives detailed email with report
   - Patient receives confirmation email
   - Patient receives SMS notification

   **If DECLINE:**
   - Case reassigned to next available specialist
   - New Slack alert sent
   - Process repeats

## üß™ **Testing Scenarios**

### **Scenario 1: Cardiology Case (High Priority)**
```bash
curl -X POST http://localhost:5678/webhook/patient-intake \
  -H "Content-Type: application/json" \
  -d '{
    "firstName": "John",
    "lastName": "Doe", 
    "age": 55,
    "gender": "Male",
    "phoneNumber": "+15551234567",
    "email": "john.doe@email.com",
    "chiefComplaint": "Chest pain and shortness of breath",
    "symptoms": "Severe chest pain, difficulty breathing, fatigue",
    "medicalHistory": "Hypertension, diabetes type 2"
  }'
```

**Expected Result:**
- Assigned to Dr. James Smith (Cardiology)
- High priority alert in Slack
- Medical report includes cardiac history

### **Scenario 2: Endocrinology Case (Medium Priority)**
```bash
curl -X POST http://localhost:5678/webhook/patient-intake \
  -H "Content-Type: application/json" \
  -d '{
    "firstName": "Jane",
    "lastName": "Smith",
    "age": 42,
    "gender": "Female",
    "phoneNumber": "+15559876543", 
    "email": "jane.smith@email.com",
    "chiefComplaint": "Fatigue and weight gain",
    "symptoms": "Extreme fatigue, unexplained weight gain",
    "medicalHistory": "Thyroidectomy, hypothyroidism"
  }'
```

**Expected Result:**
- Assigned to Dr. Michael Williams (Endocrinology)
- Report includes thyroid labs and medication history

### **Scenario 3: Test Specialist Decline Flow**

1. Submit a case
2. When Slack alert appears, click "‚ùå Decline Case"
3. Case should automatically reassign to next specialist
4. New Slack alert sent to different specialist

## üìä **Monitoring & Debugging**

### **Check Workflow Execution:**
- Go to n8n ‚Üí Executions tab
- View detailed logs for each step
- Check for any failed nodes

### **Database Queries:**
```sql
-- Check processed cases
SELECT case_id, urgency_level, specialty, status FROM patients ORDER BY created_at DESC LIMIT 5;

-- Check medical history lookup
SELECT patient_email, allergies, medications FROM patient_medical_history;

-- Check available specialists
SELECT name, specialty, availability FROM specialists ORDER BY specialty;
```

### **Redis Cache Check:**
```bash
# Connect to Redis
docker compose exec redis redis-cli -a your_redis_password_here

# Check cached cases
KEYS case:*

# View specific case
GET case:CASE-1234567890
```

## üö® **Troubleshooting**

### **Common Issues:**

#### **1. Azure OpenAI Returns [undefined]**
- Check `.env` file has correct values
- Restart n8n: `docker compose restart n8n`
- Verify Azure OpenAI deployment is active

#### **2. Slack Buttons Don't Work**
- Ensure Slack app has correct webhook URLs
- Check if bot is added to `#patient-alerts` channel
- Verify Slack credentials in n8n

#### **3. Email/SMS Not Sending**
- Check SendGrid sender verification
- Verify Twilio phone number setup
- Confirm credentials in n8n

#### **4. Database Connection Errors**
- Ensure PostgreSQL container is running
- Check database credentials match `.env` file
- Verify database name is `n8n_healthcare`

## üéØ **Next Steps for Enhancement**

1. **PDF Report Generation** - Convert HTML reports to PDF attachments
2. **Calendar Integration** - Add Calendly appointment scheduling
3. **Advanced Redis Alerts** - Monitor Slack channels for messages
4. **Patient Portal** - Web interface for patients to check status
5. **Analytics Dashboard** - Track workflow performance metrics

## üèÜ **Success Metrics**

Your pipeline is working correctly when:

- ‚úÖ **Patient data encrypts properly**
- ‚úÖ **AI correctly identifies specialists**  
- ‚úÖ **Slack alerts appear with specialist @mentions**
- ‚úÖ **Accept/Decline buttons function**
- ‚úÖ **Medical reports generate with patient history**
- ‚úÖ **Emails sent to both specialist and patient**
- ‚úÖ **SMS notifications delivered**
- ‚úÖ **Cases reassign automatically on decline**

**Congratulations! You've built a production-ready healthcare automation pipeline!** üè•üöÄ
